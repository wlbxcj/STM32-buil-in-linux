vpath %.S stlib
vpath %.c stlib platform newlib stlib/src driver/uart
vpath %.h stlib platform stlib/cminc stlib/inc driver/uart


CFLAGS += -mcpu=cortex-m3 -mthumb -Wall -std=gnu99
CFLAGS += -Wno-unused-variable					#don't waring unused variable 
#CFLAGS += -mfloat-abi=hard -mfpu=fpv4-sp-d16	#use hard float uint
CFLAGS += -nostartfiles
CFLAGS += -ffunction-sections -fdata-sections -Os
#CFLAGS += -g

LFLAGS += -mcpu=cortex-m3 -mthumb 
LFLAGS += -specs=nano.specs 
#LFLAGS += -u_printf_float 						#Use this option if you want print float
#LFLAGS += -mfloat-abi=hard -mfpu=fpv4-sp-d16
LFLAGS += -Wl,--gc-sections 
LFLAGS += -Wl,-Map=flash_sram.map

DEFS += -DUSE_STDPERIPH_DRIVER -DSTM32F10X_HD

SUBDIRS		=	$(shell ls -l | grep ^d | awk '{if($$9 != "debug") print $$9}')
OBJS_DIR	=	debug/obj

INCS += -Istlib -Istlib/cminc -Istlib/inc -Iplatform -Inewlib -Idriver/uart


SOURCES +=

CROSS_COMPILE:=~/ST/gcc-arm-none-eabi/bin/arm-none-eabi-
CC := $(CROSS_COMPILE)gcc

export CC CROSS_COMPILE OBJS CFLAGS DEFS INCS SOURCES SUBDIRS 

LD   := stm32_flash_hd.ld


SOURCES += $(wildcard stlib/*.c)
SOURCES += $(wildcard stlib/src/*.c)
SOURCES += $(wildcard driver/uart/*.c)

# All of the sources participating in the build are defined here
#-include driver/makefile

SOURCES += $(wildcard *.c)



OBJS += stlib/startup_stm32f10x_hd.o 
#OBJS += stlib/src/stm32f10x_rcc.o stlib/src/stm32f10x_gpio.o 
#OBJS += stlib/src/stm32f10x_usart.o
#OBJS += platform/init.o platform/ringbuffer.o platform/usart.o
#OBJS += newlib/syscalls.o newlib/sys_itoa.o
#OBJS += stlib/src/misc.o main.o
#OBJS += driver/uart/uart.o

OBJS += $(patsubst %.c, %.o, $(SOURCES))

OBJ_FLASH += stlib/system_stm32f10x.o #code startup from flash 
OBJ_SRAM  += stlib/system_stm32f10x_sram.o #code startup from sram 


#change flash code name and sram code name there!!
FNAME = serial
SNAME = serials

all:$(FNAME).bin
sram:$(SNAME).bin

clean:
	@echo rm .o .bin .elf...
	@rm -f $(OBJS) $(OBJ_FLASH) $(OBJ_SRAM)  
	@rm -f $(FNAME).bin $(FNAME).elf $(SNAME).bin $(SNAME).elf
	@echo
	
$(FNAME).bin:$(FNAME).elf
	@echo Finish...
	@$(CROSS_COMPILE)objcopy -O binary -S $< $@
	@echo

$(SNAME).bin:$(SNAME).elf
	@$(CROSS_COMPILE)objcopy -O binary -S $< $@


$(FNAME).elf:$(OBJS) $(OBJ_FLASH)
	@echo
	@$(CROSS_COMPILE)gcc $(LFLAGS) $^ -Tstlib/$(LD) -o $@
	@$(CROSS_COMPILE)size $@
	
$(SNAME).elf:$(OBJS) $(OBJ_SRAM)
	@$(CROSS_COMPILE)gcc $(LFLAGS) $^ -Tstlib/sram.ld -o $@
	@$(CROSS_COMPILE)size $@
	
burn:$(FNAME).bin
	@st-flash write $< 0x08000000
burns:$(SNAME).bin
	@st-flash write $< 0x20005000


	
%.o:%.S
	@echo cc: $<
	@$(CROSS_COMPILE)gcc $(CFLAGS) -c $^ -o $@
%.o:%.c
	@echo cc: $<
	@$(CROSS_COMPILE)gcc $(CFLAGS) $(DEFS) $(INCS) -c $< -o $@

.PHONY: all clean burn burns






